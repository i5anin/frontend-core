## Инфраструктура и безопасность

### Цель

Инфраструктура обеспечивает **доступность, масштабируемость и воспроизводимость** приложения, а безопасность — **устойчивость к ошибкам и атакам**. Эти две области тесно связаны: стабильная инфраструктура невозможна без защиты, а безопасность бесполезна без автоматизированных процессов и мониторинга.

---

## Основные принципы

1. **Infrastructure as Code (IaC)** — инфраструктура описывается декларативно (Terraform, Ansible, Helm).
2. **Immutable Infrastructure** — изменения через пересоздание, а не ручные правки.
3. **Least Privilege** — минимально необходимые права для сервисов и пользователей.
4. **Zero Trust** — каждый запрос проверяется, даже внутри внутренней сети.
5. **Defense in Depth** — защита на нескольких уровнях: сеть → инфраструктура → приложение → данные.
6. **Fail Fast / Recover Fast** — система должна быстро обнаруживать и устранять сбои.

---

## Среда выполнения

### Dev / Stage / Prod

* **Dev** — для локальной разработки, без реальных данных.
* **Stage** — максимально приближен к продакшену, для тестирования.
* **Prod** — боевая среда, только автоматические деплои.
* Конфигурации и секреты изолированы.

### Контейнеризация

* **Docker / Podman** — изоляция приложения и зависимостей.
* **Dockerfile** строится на лёгких базовых образах (`node:alpine`).
* Минимизируй attack surface: без root, без лишних пакетов.

Пример:

```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --omit=dev
COPY . .
USER node
CMD ["node", "dist/main.js"]
```

---

## Оркестрация

### Kubernetes

* Декларативное управление состоянием (Deployment, Service, Ingress).
* **Horizontal Pod Autoscaler (HPA)** для динамического масштабирования.
* **Secrets / ConfigMap** для конфигурации.
* **NetworkPolicy** для ограничения трафика между подами.
* **PodSecurityPolicy / OPA Gatekeeper** для политик безопасности.

### Helm / ArgoCD

* Helm — шаблонизация манифестов.
* ArgoCD — GitOps-подход, инфраструктура синхронизируется из репозитория.

---

## CI/CD

### Цепочка поставки

* **GitLab CI / GitHub Actions**: lint → build → test → deploy.
* Все артефакты версионируются.
* Деплой только через пайплайн, без ручных доступов.

Пример `.gitlab-ci.yml`:

```yaml
stages: [lint, test, build, deploy]

lint:
  script: npm run lint

test:
  script: npm run test

build:
  script: npm run build
  artifacts:
    paths: [dist]

deploy:
  environment: production
  script: bash ./scripts/deploy.sh
  when: manual
```

---

## Мониторинг и логирование

### Метрики

* **Prometheus + Grafana** — сбор и визуализация системных и бизнес-метрик.
* **Loki / Elasticsearch** — централизованные логи.
* **Alertmanager / PagerDuty** — уведомления о проблемах.

Типовые метрики:

* p95 latency
* error rate
* CPU / memory / network usage
* количество активных пользователей / запросов

### Observability

* **Tracing (Jaeger, OpenTelemetry)** — распределённые трассировки.
* **Correlate logs + traces** по `trace_id`.
* Используй **structured logging** в JSON.

---

## Безопасность инфраструктуры

### Секреты и конфигурации

* Никогда не храни ключи и токены в коде.
* Используй **HashiCorp Vault**, **AWS Secrets Manager**, **Kubernetes Secrets**.
* Шифруй переменные окружения (`sops`, `sealed-secrets`).
* Регулярная **ротация ключей** (каждые 30–90 дней).

### Контроль доступа

* RBAC (Role-Based Access Control) для всех сервисов и CI.
* MFA (многофакторная аутентификация) для админов.
* Минимизируй `sudo` и `root` права.
* Сервисные аккаунты только с нужными привилегиями.

### Сеть

* **Firewall / Security Groups** — ограничение портов и IP.
* **TLS 1.3** для всех внешних соединений.
* **mTLS (Mutual TLS)** для внутренних сервисов.
* Внутренние сети не должны быть доступны извне.
* Используй VPN или bastion host для доступа к приватной инфраструктуре.

---

## Контейнерная безопасность

* Сканирование уязвимостей (`Trivy`, `Grype`).
* Подпись образов (`cosign`, `Notary`).
* Проверка на runtime (`Falco`, `AppArmor`, `Seccomp`).
* Drop capabilities (`NET_RAW`, `SYS_ADMIN`).
* Обновление базовых образов при каждом релизе.

---

## Безопасность приложения

* CSP (Content Security Policy) — ограничение скриптов и контента.
* CORS — только по whitelist.
* Rate limiting и защита от DoS (`express-rate-limit`, Nginx `limit_req`).
* XSS защита: экранирование HTML, `v-html` — только доверенные данные.
* CSRF защита: токены и `SameSite=Lax`.
* SQL Injection — только подготовленные запросы.
* SSRF защита — фильтрация внешних запросов.

---

## Бэкапы и восстановление

* Бэкап БД и хранилищ ежедневно.
* Хранить копии в разных регионах (cross-region).
* Проверка восстановления (disaster recovery test).
* Репликация в standby кластер.

---

## Аудит и соответствие

* Логи аутентификации и действий администраторов.
* Хранение audit logs минимум 90 дней.
* Проверки уязвимостей: OWASP ZAP, Burp Suite.
* Регулярные pentest и security review.
* Соответствие стандартам:

    * **OWASP Top 10**
    * **ISO 27001**
    * **GDPR / PCI DSS / SOC2**

---

## Инцидент-менеджмент

1. **Обнаружение** — метрики, логи, алерты.
2. **Классификация** — определение влияния и приоритета.
3. **Митигирование** — rollback, ограничение трафика, временное отключение.
4. **Постмортем** — анализ причин, план улучшений, обновление документации.
5. **Коммуникация** — один ответственный, один канал уведомлений.

---

## Hardening Checklist

| Категория  | Практики                                                   |
| ---------- | ---------------------------------------------------------- |
| OS         | регулярные обновления, `fail2ban`, отключение root-login   |
| CI/CD      | ограниченные токены, валидация PR, защита от supply chain  |
| DB         | отдельный пользователь для каждого сервиса, SSL-соединения |
| Cloud      | минимальные IAM-права, CloudTrail/CloudWatch включены      |
| Network    | firewall, TLS, сегментация, VPN                            |
| Secrets    | Vault / SOPS / Sealed Secrets                              |
| Access     | MFA, временные токены, RBAC                                |
| Backup     | ежедневный, зашифрованный, тест восстановления             |
| Monitoring | метрики, алерты, SLA/SLO                                   |

---

## Пример практической схемы

```
[ User ] 
   ↓ HTTPS
[ CDN / WAF ]
   ↓
[ API Gateway ]
   ↓
[ Kubernetes Cluster ]
   ├── Auth Service (JWT + RBAC)
   ├── App Service (REST/gRPC)
   ├── Cache (Redis)
   ├── DB (PostgreSQL, encrypted)
   ├── Secrets (Vault)
   ↓
[ Monitoring + Alerting ]
   ↓
[ Incident Response + Audit Logs ]
```

---

## Ключевые метрики безопасности и устойчивости

| Метрика                           | Цель                                    |
| --------------------------------- | --------------------------------------- |
| MTTR (Mean Time To Recovery)      | время восстановления после сбоя         |
| MTBF (Mean Time Between Failures) | надёжность системы                      |
| Change Failure Rate               | процент неудачных релизов               |
| Vulnerability Age                 | среднее время существования уязвимости  |
| Patch latency                     | время между выпуском и установкой патча |
| Unauthorized Access Attempts      | контроль вторжений                      |

---

## Чек-лист безопасной инфраструктуры

1. Конфигурация и инфраструктура описаны кодом (IaC).
2. Доступ к продакшену только через MFA и ограниченные роли.
3. Secrets и токены не хранятся в коде.
4. CI/CD проверяет безопасность зависимостей.
5. Контейнеры минимальны и подписаны.
6. Все соединения — через HTTPS/TLS 1.3.
7. Мониторинг и алерты активны.
8. Бэкапы проверяются.
9. Регулярный security review.
10. План реагирования на инциденты задокументирован.

---

Современная инфраструктура — это **код, автоматизация и безопасность по умолчанию**.
Главный принцип: *не доверяй ни одному уровню, проверяй каждый, и всегда планируй восстановление прежде, чем произойдёт сбой.*
