# Внутреннее устройство JavaScript (кратко)

## 1. Однопоточная модель выполнения

JavaScript выполняется в **одном потоке**.  
Одновременно обрабатывается только одна операция.  
Параллельности нет — есть _кооперативная многозадачность_ через event loop.

---

## 2. Call Stack (стек вызовов)

Структура, где движок хранит активные функции.

Процесс:

1. Вызов функции → помещается в стек.
    
2. Завершение функции → удаляется из стека.
    
3. Глубокая рекурсия → переполнение стека (stack overflow).
    

Стек всегда синхронен.

---

## 3. Heap (куча)

Память для объектов, массивов, функций.  
Хранит данные динамического размера.  
Сборщик мусора освобождает недоступные объекты.

---

## 4. Event Loop (цикл событий)

Механизм, который управляет очередями задач.

Работа:

1. JS выполняет стек.
    
2. Когда стек пуст, Event Loop переносит задачи из очередей в стек.
    

### Очереди:

- **Macro-task queue:**  
    `setTimeout`, `setInterval`, `setImmediate`, I/O, рендер.
    
- **Micro-task queue:**  
    `Promise.then`, `async/await` после `await`, `queueMicrotask`, MutationObserver.
    

Правило:  
**Сначала выполняются все microtask, затем берётся одна macrotask.**

---

## 5. Execution Context (контекст выполнения)

Каждый запуск функции создаёт собственный контекст.

Состав:

- Lexical Environment (лексическое окружение)
    
- Variable Environment
    
- значение `this`
    
- ссылка на внешний контекст
    

---

## 6. Lexical Environment

Структура, в которой движок хранит переменные и функции.

Компоненты:

- **Environment Record** — таблица ключ/значение.
    
- **Outer Environment Reference** — ссылка на внешнюю область.
    

Проще:  
Это цепочка областей видимости → основа замыканий.

---

## 7. Замыкания на уровне движка

Функция сохраняет ссылку на Lexical Environment, в котором была создана.  
Пока функция жива — окружение не удаляется сборщиком мусора.

Это даёт доступ к переменным даже после завершения внешней функции.

---

## 8. Hoisting (подъём)

Перед выполнением кода движок подготавливает переменные и функции.

Правила:

- `function declaration` поднимаются полностью.
    
- `var` поднимается, но без значения (инициализация — `undefined`).
    
- `let` и `const` создаются в TDZ (temporal dead zone) → доступ до объявления запрещён.
    

---

## 9. Memory Management / GC

Сборщик мусора работает по принципу **mark-and-sweep**:

1. Отмечает доступные объекты (start: global → stack → ссылки).
    
2. Удаляет неотмеченные.
    

Частные детали GC зависят от движка (V8, SpiderMonkey), но логика одинакова.

---

## 10. Hidden Classes / Inline Cache (V8)

Оптимизации, полезные на собеседовании.

### Hidden Classes

V8 создаёт «скрытые классы» для объектов, чтобы ускорять доступ к свойствам.  
Структура объекта должна быть стабильной: одинаковый порядок добавления полей.

Нестабильные объекты → деоптимизация.

### Inline Cache

Кэш для быстрых повторных обращений к одному и тому же свойству.

---

## 11. Движки JS (кратко)

Сам язык — это спецификация ECMAScript.  
Работают под ним разные движки:

- Chrome / Node.js → **V8**
    
- Firefox → **SpiderMonkey**
    
- Safari → **JavaScriptCore**
    

Каждый реализует:

- парсер
    
- интерпретатор
    
- JIT-компиляцию
    
- GC
    

---

# Итог

Базовые элементы внутреннего устройства JavaScript:

- однопоточная модель
    
- стек вызовов
    
- heap
    
- event loop + очереди micro/macro
    
- execution context + lexical environment
    
- hoisting + TDZ
    
- сборщик мусора
    
- скрытые классы и JIT-оптимизации
    
